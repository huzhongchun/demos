Jumei.widget("ui.waterFall",{init:function(e){this.options={id:"waterfall-boxs",columnWidth:140,columnClassName:"waterfall-column",columnGap:0,cellSelector:"cell",imgSelector:"img",hasSetImgHeight:!0,fadeIn:!0,fadeInTime:600,insertType:2},this._super.call(this,e)},_create:function(){$.fn.fadeTo=function(e,n){return this.each(function(){$(this).animate({opacity:n},e,"ease",function(){})})};var e=this,n=this.options;if(!n.id||!$("#"+n.id))return console.log("id或dom为null！"),!1;e.$dom=$("#"+n.id),e.$dom.addClass("clearfloat");var t=e.$dom.width();return e.columnAmount=parseInt((t+n.columnGap)/(n.columnWidth+n.columnGap)),e.columnAmount<1?(alert("列的宽度过大,请重新调节列的宽度！"),!1):(e.childs=e.$dom.children().detach(),e.$column=e.createColnum(e.columnAmount),void e.appendChilds(e.childs))},appendChilds:function(e){var n=this,t=this.options;return e.length?void e.each(function(e){var i=this,o=e;if(t.hasSetImgHeight)2==t.insertType?n.insertByOder($(i),o,t.fadeIn):n.insertByMinHieght($(i),t.fadeIn);else if("img"==$(i)[0].nodeName.toLowerCase()||$(i).find(t.imgSelector).length>0){var a=new Image,l="img"==$(i)[0].nodeName.toLowerCase()?$(i).attr("src"):$(i).find(t.imgSelector).attr("src");a.onload=function(){a.onreadystatechange=null,2==t.insertType?n.insertByOder($(i),o,t.fadeIn):n.insertByMinHieght($(i),t.fadeIn),a=null},a.onreadystatechange=function(){"complete"==a.readyState&&(a.onload=null,2==t.insertType?n.insertByOder($(i),o,t.fadeIn):n.insertByMinHieght($(i),t.fadeIn),a=null)},a.src=l}}):!1},createColnum:function(e){for(var n=this,t=this.options,i="",o=0;e>o;o++){var a=(o+1)%n.columnAmount==0?0:t.columnGap;i+="<div class="+t.columnClassName+' style="float:left;width:'+t.columnWidth+"px;overflow:hidden;margin-right:"+a+"px;margin-bottom:"+t.columnGap+'px;"></div>'}return n.$dom.prepend(i),$("."+t.columnClassName)},insertByOder:function(e,n,t){var i=this,o=this.options,a=n%i.columnAmount;t?$(e).css("opacity",0).appendTo(i.$column[a]).fadeTo(o.fadeInTime,1):$(e).appendTo(i.$column[a])},insertByMinHieght:function(e,n){for(var t=this,i=this.options,o=0,a=1e7,l=$(".waterfall-column"),r=0;r<l.length;r++)$(l[r]).height()<a&&(a=$(l[r]).height(),o=r);n?$(e).css("opacity",0).appendTo(t.$column[o]).fadeTo(i.fadeInTime,1):$(e).appendTo(t.$column[o])}});