define(["view","distance"],function(t,i){var e,a,n=['<div class="beauty-index-wrapper">','<div class="index-header">','<span class="city-select" city="北京">北京</span>','<input class="search-custom" readonly="readonly" placeholder="搜商户" type="text"/>','<span class="my-group">我的团购</span>',"</div>",'<div id="beauty-index-container" class="beauty-index-container">','<div id="beauty-index-scroll">','<div class="banner-container">',"<div>","<a></a>","</div>","</div>",'<div class="category-wrapper">','<div class="category-icon" id="category-slider">','<div class="clear">','<div class="li-list" type="丽人"><img src="<%=static%>beauty/image/all.jpg?123"/></div>','<div class="li-list" type="美发"><img src="<%=static%>beauty/image/hair_salon.jpg?123"/></div>','<div class="li-list" type="美容"><img src="<%=static%>beauty/image/beauty.jpg?123"/></div>','<div class="li-list" type="SPA"><img src="<%=static%>beauty/image/spa.jpg?123"/></div>','<div class="li-list" type="美甲"><img src="<%=static%>beauty/image/nail_art.jpg?123"/></div>','<div class="li-list" type="齿科"><img src="<%=static%>beauty/image/dental.jpg?123"/></div>','<div class="li-list" type="瑜伽"><img src="<%=static%>beauty/image/yoga.jpg?123"/></div>','<div class="li-list" type="瘦身纤体"><img src="<%=static%>beauty/image/thin_body.jpg?123"/></div>',"</div>",'<div class="clear">','<div class="li-list" type="舞蹈"><img src="<%=static%>beauty/image/dance.jpg?333"/></div>','<div class="li-list" type="写真"><img src="<%=static%>beauty/image/photo.jpg?123"/></div>','<div class="li-list" type="整形"><img src="<%=static%>beauty/image/plastic.jpg?123"/></div>',"</div>","</div>","</div>",'<section class="custom-category">','<div class="custom-header"> 附近最热</div>','<div class="custom-container">',"</div>","</section>",'<div class="pullUp" id="pullUp">','<span class="pullUpLabel">点击查看更多</span>',"</div>","</div>","</div>",'<div class="erea-select-list hidden" id="erea-select-list">','<div class="area-iscroll">','<ul class="clear">',"</ul>","</div>",'<div class="current-city-content">当前城市：<span class="current-city"></span> <span class="change-city">更换</span></div>',"</div>",'<div id="main_bg"></div>',"</div>"].join(""),l=["<ul>","<% for(var i = 0; i < businesses.length; i++){ var item = businesses[i]; %>",'<% if(param.latitude != "undefined" && param.latitude !=0 && item.latitude != 0){ %>',"<% var distances = param.distance.getDistance(param.latitude,param.longitude,item.latitude,item.longitude); %>","<% if(distances>=1000){%>",'<% distances = (distances/1000).toFixed(1) + "km";%>',"<% }else{%>",'<% distances = parseInt(distances) + "m";%>',"<% }%>","<% }%>","<% if(item.deals.length>0) {%>",'<li class="custom-list">','<div class="list-title" business_id="<%=item.business_id%>"><span class="list-title-cut"><%=item.name%><% if(item.branch_name &&item.branch_name !="") { %>(<%=item.branch_name%>)<%}%></span><span class="custom-distance"><%=distances%></span></div>','<ul class="list-content" <%if(item.deals.length>2){ %>style = "height:173px;"<%}%> >',"<% for(var j = 0; j < item.deals.length; j++){ var list = item.deals[j];%>","<li deal_id = <%=list.deal_id%>>",'<img src="<%=list.image_url%>"/>',"<% if(list.restrictions && list.restrictions.is_reservation_required != 1){ %>",'<img class="is-yuyue" src="<%=static%>beauty/image/free_make@2x.png"/>',"<% } %>",'<div class="list-content-content">','<div class="content-desc"><%=list.description%></div>','<div class="content-price"><span class="current-price">¥<%=list.current_price%></span><span class="old-price">¥<%=list.list_price%></span><span class="sale-num">已售:<%=list.purchase_count%></span></div>',"</div>","</li>","<% } %>","</ul>",'<div class="list-content-more hidden" <%if(item.deals.length>2){ %>style = "display:block;"<%}%> >更多团购项目</div>',"</li>","<% } %>","<% } %>","</ul>"].join(""),c=['<ul class="clear">','<ul class="clear">',"<% var num = item.length%4;if(num>0){num = 4-num;}%>","<% for(var j = 0; j < item.length; j++){ var list = item[j]; %>","<li><%=list.district_name%></li>","<% } %>","<% for(var z = 0; z < num; z++){%>","<li></li>","<% } %>","</ul>"].join(""),s=null,r=function(){s=null,$("#pullUp").off("click"),$("#pullUp").on("click",function(){a=document.querySelector("#beauty-index-container .pullUp"),a.querySelector(".pullUpLabel").innerHTML="加载中...",d.getList()})},o={latitude:0,longitude:0},d={currentPage:0,currentCity:"北京",currentArea:null,category:"丽人",totalPage:0,loadFlag:!0,latitude:0,longitude:0,getList:function(t){if(d.loadFlag){d.loadFlag=!1;var e={},n=this;null!=d.currentCity||0==d.latitude&&0==d.longitude?(e.city=d.currentCity||"北京",e.page=++n.currentPage,e.limit=15,null!=d.currentArea&&(e.region=d.currentArea),0!=d.latitude&&0!=d.longitude&&(e.latitude=d.latitude,e.longitude=d.longitude,e.sort=7)):e={latitude:d.latitude,longitude:d.longitude,radius:-1,page:++n.currentPage,latitude:d.latitude,longitude:d.longitude,sort:7,limit:15},$("#wrapper").loadding(),$.ajax({type:"get",dataType:"json",data:e,url:"/dp/getTopBusinessesByLocation",success:function(e){if($("#wrapper").loadding("close"),"OK"==e.status&&e.businesses.length>0){n.totalPage=e.total_count,e.param=o,e.param.distance=i,e.static=Jumei.static;var c=Jumei.parseTpl(l,e);1==t?$("#beauty_index .custom-container").html(c):$("#beauty_index .custom-container").append(c),$("#beauty_index .content-desc").subStr(46),$("#beauty_index .list-title .list-title-cut").subStr(35),$("#beauty-index-container").height()>$("#beauty-index-scroll").height()?$("#pullUp").hide():$("#pullUp").show(),a&&(a.querySelector(".pullUpLabel").innerHTML="点击查看更多")}else 1==d.currentPage&&($("#beauty_index .custom-container").html('<div class="empty-tip"></div>'),j('<div class="dialog-alert">没有当前城市的团购信息！</div>')),$("#pullUp").hide();d.loadFlag=!0},error:function(){d.loadFlag=!0,$("#wrapper").loadding("close")}})}}},u=function(t,i){var e=!1;d.currentPage=0,d.totalPage=0,d.latitude=o.latitude,d.longitude=o.longitude,(t!=d.currentCity||i!=d.area)&&(d.currentCity=t,d.currentArea=i,d.latitude=0,d.longitude=0,e=!0,d.getList(e))},g=!0,y="",p=function(t){window.citys={},window.citysEn={};for(var i in t)if(t.hasOwnProperty(i))for(var e=0;e<t[i].length;e++)window.citys[t[i][e].city_name]=t[i][e].districts,window.citysEn[t[i][e].city_name]=t[i][e].enname},m=function(t){window.citysOrigin||g&&(g=!1,$("#wrapper").loadding(),$.ajax({type:"get",dataType:"json",url:"/dp/getCities",success:function(i){g=!0,$("#wrapper").loadding("close"),i&&(p(i),window.citysOrigin=i,t&&t.call(e))},error:function(){g=!0,$("#wrapper").loadding("close")}}))},v=function(t,i){$.ajax({type:"get",dataType:"json",url:"/dp/getCityNameByLocation",data:{location:i+","+t},success:function(a){a&&(y=a.city,a.latitude=t,a.longitude=i,d.latitude=o.latitude=t,d.longitude=o.longitude=i,e.controller.getStoryItem("liren_city")&&e.controller.getStoryItem("liren_city")!=a.city?e.param.city?(d.latitude=0,d.longitude=0,d.currentCity=e.controller.getStoryItem("liren_city"),h(),e.initList()):$("#wrapper").dialog({width:260,height:200,content:'<div id="position-icon"></div><div id="change-city-dialog">目前您的定位城市在'+a.city+"，是否切换？</div>",title:"",type:2,init:function(){var t=$(".alert-dialog-btn");t.off("click"),t.on("click",function(){$("#container-dialog").remove(),location.reload()})},ok:"切换",cancel:"取消",successCallback:function(){e.controller.setStoryItem("liren_city",a.city),h(),e.initList()},cancelCallback:function(){d.latitude=0,d.longitude=0,d.currentCity=e.controller.getStoryItem("liren_city"),h(),e.initList()}}):(e.controller.setStoryItem("liren_city",a.city),e.controller.setStoryItem("liren_pos",JSON.stringify(o)),e.initList(),$(".city-state-fail").hide(),$(".city-state").show()))},error:function(){}})},h=function(){var t=e.controller.getStoryItem("liren_city");t&&($(".city-select").attr("city",t),$(".city-select").html(b(t)),d.currentCity=t)},f=function(){e.controller.getStoryItem("liren_city")?e.initList():$("#wrapper").dialog({width:260,height:200,content:'<div id="position-fail">定位失败，请手动选择城市</div>',title:"",type:1,init:function(){},ok:"确定",cancel:"取消",successCallback:function(){$(".change-city").trigger("click")}})},b=function(t){var i="";if(t)for(var e=0;2>e;e++)i+=t[e];$(".city-select").html(i)},w=function(){var t="";t=$.os.iphone?"iphone":"android",$.ajax({type:"get",dataType:"json",url:"/dp/ads",data:{platform:t},success:function(t){if(t&&t.card_list.length>0&&t.card_list[0].material.length>0){var i=$(".banner-container div a");$(".banner-container").show();var e='<img src="'+t.card_list[0].material[0].img[640]+'"/>';i.html(e),i.attr("jump",t.card_list[0].material[0].content)}},error:function(){}})},_=function(){$(".erea-select-list").addClass("hidden"),$("#main_bg").hide()},j=function(t){e.hasCurrentView()&&$("#wrapper").dialog({width:260,height:200,content:t,title:"",type:1,init:function(){},ok:"我知道了",cancel:"取消",successCallback:function(){}})};return Jumei.create(t,{onEvent:function(){var t=this;this.iscrollFlag=!1,this.events={"click .li-list":function(){var i=$(this).attr("type"),e=d.currentCity,a="";window.area&&(a="&area="+window.area),Jumei.ja("dpevent","category"+i),t.forward("#module=beauty&action=category&type="+i+a+"&city="+e+"&latitude="+o.latitude+"&longitude="+o.longitude+"&pos_city="+y)},"click .list-content-more":function(){$(this).hide(),$(this).parent().find(".list-content").height("auto")},"click .my-group":function(){login.isLogin(function(i){0>=i?location.href="jumeimall://page/login":t.forward("#module=beauty&action=my_beauty&latitude="+o.latitude+"&longitude="+o.longitude)})},"click .city-select":function(){function t(){var t={};if(t.item=window.citys[$(e).attr("city")],t.item){var i=Jumei.parseTpl(c,t);$(".area-iscroll").html(i)}else $(".area-iscroll").html("")}var i=$(".erea-select-list"),e=this;i.hasClass("hidden")?(i.removeClass("hidden"),$("#main_bg").show(),$(".current-city").html($(".city-select").attr("city")),window.citys?t():m(t)):($("#main_bg").hide(),i.addClass("hidden")),$("#main_bg").off("click"),$("#main_bg").on("click",function(){i.addClass("hidden"),$(this).hide()}),Jumei.ja("dpevent","citybtn")},"click .change-city":function(){_(),t.forward("#module=beauty&action=city_search&city="+$(".city-select").attr("city")),Jumei.ja("dpevent","changecity")},"click #erea-select-list ul li":function(){_(),window.area=$(this).html(),e.controller.setStoryItem("liren_area",window.area),$(".city-select").html(b(window.area)),u($(".city-select").attr("city"),window.area)},"click .list-content li":function(){var i=$(this).parent().parent().find(".list-title").attr("business_id"),e=$(this).find("img").attr("src");Jumei.ja("dpevent","detail首页"),t.forward("#module=beauty&action=detail&deal_id="+$(this).attr("deal_id")+"&business_id="+i+"&latitude="+o.latitude+"&longitude="+o.longitude+"&image_url="+e)},"click .search-custom":function(){t.forward("#module=beauty&action=search&city="+$(".city-select").attr("city")+"&latitude="+o.latitude+"&longitude="+o.longitude),Jumei.ja("dpevent","searchbtn")},"click .close-search-category":function(){$("#search-category").height(0)},"click .banner-container div a":function(){var t=$(this).attr("jump");Jumei.ja("dpevent","ads"),e.href(t)}}},onCreate:function(){e=this;var t={"static":Jumei.static},i=Jumei.parseTpl(n,t);if(this.elem.html(i),this.initSlider(),1==this.controller.getStoryItem("liren_first"))e.initIndex();else{var a=$(".first-tip"),l=null;a.show(),60==e.headerHeight&&a.addClass("first-tip-show"),l=setTimeout(function(){a.hide(),e.initIndex()},23e3),this.controller.setStoryItem("liren_first",1),a.off("click"),a.on("click",function(){$(this).hide(),clearTimeout(l),e.initIndex()})}},initIndex:function(){d.currentPage=0,window.area=d.currentArea=e.controller.setStoryItem("liren_area")?e.controller.setStoryItem("liren_area"):null,h(),m(),r(),this.initPos(),w()},setTitle:function(){this.title("丽人生活团")},onRefresh:function(){_(),this.setTitle()},initSlider:function(){new Slider("category-slider",{index:0})},onShow:function(){},initList:function(){d.getList()},initPos:function(){function t(){navigator.geolocation?(navigator.geolocation.getCurrentPosition(i,e),setTimeout(function(){a&&(a=!1,h(),f())},1e4)):(h(),f())}function i(t){a&&(a=!1,o.longitude=t.coords.latitude,o.latitude=t.coords.longitude,v(o.longitude,o.latitude))}function e(t){if(a)switch(a=!1,t.code){case t.PERMISSION_DENIED:case t.POSITION_UNAVAILABLE:case t.TIMEOUT:case t.UNKNOWN_ERROR:h(),f()}}var a=!0;t()}})});