define(["view"],function(a){var e=['<div id="submit-orders-wrapper">','<div class="orders-list-content">','<div class="submit-orders-list">','<div class="orders-title"><%=title%></div>','<div class="orders-detail">','<div class="product-price">','<span class="product-label">单价</span>','<span class="product-price-value fr">¥<%=price%></span>',"</div>",'<div class="line"></div>','<div class="product-num">','<span class="product-label">数量</span>','<span class="product-num-control fr">','<span class="sub-num"></span>','<input type="text" id="quantity" readonly="readonly" value="1"/>','<span class="add-num"></span>',"</span>","</div>",'<div class="line"></div>','<div class="total-price">','<span class="product-label">总价</span>','<span class="fr total-price-value">¥<span><%=price%></span></span>',"</div>","</div>","</div>","</div>",'<div class="orders-user-info">','<div class="user-info-list">','<span class="user-info-label">手机号</span>','<input type="tell" class="user-phone" placeholder="填写手机号码"/>','<span class="get-code">获取验证码</span>',"</div>",'<div class="line"></div>','<div class="user-info-list">','<span class="user-info-label">验证码</span>','<input type="tell" class="user-ok-code" placeholder="填写短信验证码"/>',"</div>","</div>",'<div class="orders-tag">','<% if(required != "1"){ %>','<span class="mian-yu-yue">免预约</span>',"<% } %>",'<span class="wei-xiao-fei">未消费退款</span>','<span class="guo-qi">过期自动退款</span>',"</div>",'<div class="bottom-fixed" style="position:absolute;bottom:0px;"><div class="submit-orders-btn">提交订单</div></div>',"</div>"].join(""),s=null,i=function(a){window.scrollTo(0,0),s.hasCurrentView()&&$("#wrapper").dialog({width:260,height:200,content:a,title:"",type:1,init:function(){},ok:"我知道了",cancel:"取消",successCallback:function(){$("#header").css("position","fixed !important"),window.scrollTo(0,0)}})},t=function(){var a=$(".user-phone").val();return""==a?(i('<div class="dialog-alert">请输入手机号码！</div>'),!1):/^\d{11}$/g.test(a)?!0:(i('<div class="dialog-alert">请输入正确的手机号码！</div>'),!1)},n=function(a){var e=$(".user-phone").val();$.ajax({type:"get",dataType:"json",data:{phone:e},url:"/dp/sendCaptcha",success:function(e){1==e.status?(i('<div class="dialog-alert">短信验证码已发送到您的手机，<br/>请稍侯...</div>'),l(a)):i('<div class="dialog-alert">'+e.message+"</div>")},error:function(){}})},r=null,l=function(a){var e=60;clearInterval(r),r=setInterval(function(){--e,$(a).html(e+"s后重发"),0>e&&(clearInterval(r),$(a).html("获取验证码"))},1e3)},o=function(a){var e=$(".user-phone").val(),t=$(".user-ok-code").val().trim();return""==t?void i('<div class="dialog-alert">请输入正确的验证码！</div>'):void $.ajax({type:"get",dataType:"json",data:{phone:e,code:t},url:"/dp/checkCaptcha",success:function(e){1==e.status?a&&a.call(s):i('<div class="dialog-alert">短信验证码错误！</div>')},error:function(){}})};return Jumei.create(a,{onCreate:function(){var a=this,i={price:a.param.price,title:a.param.title,required:a.param.required},t=Jumei.parseTpl(e,i);s=this,a.elem.html(t),$("#beauty_submit_orders .orders-title").subStr(35),$(".user-phone").blur(function(){}),$(".user-phone").focus(function(){$("#header").css("position","absolute !important")}),$(".user-ok-code").focus(function(){$("#header").css("position","absolute !important")}),$("#back").on("tap",function(){$("#header").css("position","fixed !important")}),$("#home").on("tap",function(){$("#header").css("position","fixed !important")}),$("#submit-orders-wrapper").css({height:s.height+"px",position:"relative"})},setTitle:function(){this.title("提交订单")},onRefresh:function(){this.setTitle()},onEvent:function(){var a=this;this.events={"click .add-num":function(){var e=$("#quantity").val(),i=0;if(s.param.limit>0){if(e=parseInt(e)+1,e>s.param.limit)return}else e=parseInt(e)+1;$("#quantity").val(e),$(".sub-num").addClass("sub-num-select"),i=/\d*\.\d*/.test(a.param.price)?(e*a.param.price).toFixed(2):e*a.param.price,$(".total-price-value span").html(i)},"click .sub-num":function(){var e=$("#quantity").val(),s=0;e>1&&(e=parseInt(e)-1,$("#quantity").val(e),s=/\d*\.\d*/.test(a.param.price)?(e*a.param.price).toFixed(2):e*a.param.price,$(".total-price-value span").html(s),1>=e&&$(this).removeClass("sub-num-select"))},"click .submit-orders-btn":function(){t()&&o(function(){$("#header").css("position","fixed !important"),a.forward("#module=beauty&action=conform_orders&deal_id="+a.param.deal_id+"&categories="+s.param.categories+"&price="+a.param.price+"&total_price="+$(".total-price-value span").html()+"&phone="+$(".user-phone").val()+"&num="+$("#quantity").val()+"&title="+s.param.title+"&image_url="+s.param.image_url+"&dealgroupid="+s.param.dealgroupid)}),Jumei.ja("dpevent","submitorder")},"click .get-code":function(){t()&&n(this)},"change #quantity":function(){var e=$(this).val();$(".total-price-value span").html(e*a.param.price),1>=e?$(".sub-num").removeClass("sub-num-select"):$(".sub-num").addClass("sub-num-select")}}},onClose:function(){},onRefresh:function(){clearInterval(r),$(".get-code").html("获取验证码")}})});