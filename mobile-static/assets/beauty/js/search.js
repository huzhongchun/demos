define(["view","distance"],function(t,i){var e=['<div id="search-category">','<div id="search-category-header">','<div id="search-input-wrapper" class="clear">','<input type="search" placeholder="搜商户" class="search-category-input" />','<span id="search-category-btn">搜索</span>',"</div>",'<div class="search-close"></div>',"</div>",'<div id="search-category-tag" class="clear">',"<span>木子造型</span>","<span>美联社</span>","<span>修颜造型</span>","<span>凤王美</span>","</div>",'<div id="search-category-list">','<div class="search-category-scroll"></div>',"</div>","</div>"].join(""),s=["<ul>","<% for(var i = 0; i < businesses.length; i++){ var item = businesses[i]; %>",'<% if(param.latitude != "undefined" && param.latitude !=0 && item.latitude != 0){ %>',"<% var distances = param.distance.getDistance(param.latitude,param.longitude,item.latitude,item.longitude); %>","<% if(distances>=1000){%>",'<% distances = (distances/1000).toFixed(1) + "km";%>',"<% }else{%>",'<% distances = parseInt(distances) + "m";%>',"<% }%>","<% }%>","<% if(item.deals.length>0) {%>",'<li class="custom-list">','<div class="list-title" business_id="<%=item.business_id%>"><span class="list-title-cut"><%=item.name%><% if(item.branch_name &&item.branch_name !="") { %>(<%=item.branch_name%>)<%}%></span><span class="custom-distance"><%=distances%></span></div>','<ul class="list-content" <%if(item.deals.length>2){ %>style = "height:173px;"<%}%> >',"<% for(var j = 0; j < item.deals.length; j++){ var list = item.deals[j];%>","<li deal_id = <%=list.deal_id%>>",'<img src="<%=list.image_url%>"/>',"<% if(list.restrictions && list.restrictions.is_reservation_required != 1){ %>",'<img class="is-yuyue" src="<%=static%>beauty/image/free_make@2x.png"/>',"<% } %>",'<div class="list-content-content">','<div class="content-desc"><%=list.description%></div>','<div class="content-price"><span class="current-price">¥<%=list.current_price%></span><span class="old-price">¥<%=list.list_price%></span><span class="sale-num">已售:<%=list.purchase_count%></span></div>',"</div>","</li>","<% } %>","</ul>",'<div class="list-content-more hidden" <%if(item.deals.length>2){ %>style = "display:block;"<%}%> >更多团购项目</div>',"</li>","<% } %>","<% } %>","</ul>"].join(""),a=!0,n=null,l={latitude:0,longitude:0},c=function(t){if(a){a=!1;var e={keyword:t,city:n.param.city,limit:30};0!=l.latitude&&(e.latitude=l.latitude,e.longitude=l.longitude,e.radius=-1),$("#wrapper").loadding(),$.ajax({type:"get",dataType:"json",url:"/dp/searchByCity",data:e,success:function(t){if(a=!0,$("#wrapper").loadding("close"),"OK"==t.status&&t.businesses.length>0){t.param=l,t.param.distance=i,t.static=Jumei.static;var e=Jumei.parseTpl(s,t);$("#search-category-list .search-category-scroll").html(e),$(".search-category-scroll .content-desc").subStr(45),$(".search-category-scroll .list-title .list-title-cut").subStr(35),r()}else{var n='<div id="find-empty">什么也没找到~<br>看看文字输入是否有误</div>';$("#search-category-list .search-category-scroll").html(n),r()}},error:function(){a=!0,$("#wrapper").loadding("close")}})}},r=function(){};return Jumei.create(t,{onCreate:function(){n=this,l.latitude=n.param.latitude,l.longitude=n.param.longitude,this.elem.html(e)},onEvent:function(){var t=this;this.iscrollFlag=!1,this.events={"click #search-category-btn":function(){var t=$(".search-category-input").val();Jumei.ja("searchkey",t),c(t),Jumei.ja("dpevent","confirmsearch")},"click .list-content li":function(){var i=$(this).parent().parent().find(".list-title").attr("business_id"),e=$(this).find("img").attr("src");Jumei.ja("dpevent","detail搜索"),t.forward("#module=beauty&action=detail&deal_id="+$(this).attr("deal_id")+"&business_id="+i+"&latitude="+l.latitude+"&longitude="+l.longitude+"&image_url="+e)},"click .list-content-more":function(){$(this).hide(),$(this).parent().find(".list-content").height("auto"),r()},"click .search-close":function(){history.go(-1)}}},onClose:function(){},setTitle:function(){this.title("丽人团搜索")},onRefresh:function(){this.setTitle()}})});