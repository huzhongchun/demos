define(["view","distance"],function(t,e){var i,s,a=['<div class="category-select"> ','<span class="category-liren" type="category-liren"><span>全部</span><i class="down-icon"></i></span>','<span class="category-shangqu" type="category-shangqu"><span>全部商区</span><i class="down-icon"></i></span>','<span class="category-paixu" type="category-paixu"><span>智能排序</span><i class="down-icon"></i></span>',"</div>",'<div class="user-position"><div class="user-position-content">某某区区域某某城<span class="position-refresh"></span></div></div>','<div id="beauty-category-wrapper">','<div id="category-scroll">','<section class="custom-category" id="custom-category">','<div class="custom-container">',"</div>","</section>",'<div class="pullUp" id="pullUpCategory">','<span class="pullUpLabel">点击查看更多</span>',"</div>","</div>","</div>",'<div id="category-liren-list" class="category-common-type">','<div id="liren-list-scroll">',"<ul>",'<li type="丽人" html="全部" class="丽人 selected">全部</li>','<li type="美发" html="美发" class="美发">美发</li>','<li type="美容" html="美容" class="美容">美容</li>','<li type="SPA" html="SPA" class="SPA">SPA</li>','<li type="美甲" html="美甲" class="美甲">美甲</li>','<li type="齿科" html="齿科" class="齿科">齿科</li>','<li type="瑜伽" html="瑜伽" class="瑜伽">瑜伽</li>','<li type="瘦身纤体" html="瘦身" class="瘦身纤体">瘦身</li>','<li type="舞蹈" html="舞蹈" class="舞蹈">舞蹈</li>','<li type="写真" html="摄影写真" class="写真">摄影写真</li>','<li type="整形" html="整形" class="整形">整形</li>',"</ul>","</div>",'<div class="bottom"></div>',"</div>",'<div id="category-shangqu-list" class="category-common-type">','<div id="shangqu-list-scroll">',"<ul>","</ul>","</div>",'<div id="shangqu-second-scroll">',"<ul>","</ul>","</div>",'<div class="bottom"></div>',"</div>",'<div id="category-paixu-list" class="category-common-type">','<div id="paixu-list-scroll">',"<ul>",'<li type = "1" class="selected">智能排序</li>','<li type = "2">评价最高</li>','<li type = "4">环境好评</li>','<li type = "5">服务好评</li>','<li type = "7">离我最近</li>','<li type = "8">价格最低</li>',"</ul>","</div>",'<div class="bottom"></div>',"</div>",'<div id="category_bg"></div>'].join(""),l=["<ul>","<% for(var i = 0; i < businesses.length; i++){ var item = businesses[i]; %>",'<% if(param.latitude != "undefined" && param.latitude !=0 && item.latitude != 0){ %>',"<% var distances = param.distance.getDistance(param.latitude,param.longitude,item.latitude,item.longitude); %>","<% if(distances>=1000){%>",'<% distances = (distances/1000).toFixed(1) + "km";%>',"<% }else{%>",'<% distances = parseInt(distances) + "m";%>',"<% }%>","<% }%>",'<li class="custom-list">','<div class="list-title" business_id="<%=item.business_id%>"><span class="list-title-cut"><%=item.name%><% if(item.branch_name &&item.branch_name !="") { %>(<%=item.branch_name%>)<%}%></span><span class="custom-distance"><%=distances%></span></div>','<ul class="list-content" <%if(item.deals.length>2){ %>style = "height:173px;"<%}%> >',"<% for(var j = 0; j < item.deals.length; j++){ var list = item.deals[j];%>","<li deal_id = <%=list.deal_id%>>",'<img src="<%=list.image_url%>"/>',"<% if(list.restrictions && list.restrictions.is_reservation_required != 1){ %>",'<img class="is-yuyue" src="<%=static%>beauty/image/free_make@2x.png"/>',"<% } %>",'<div class="list-content-content">','<div class="content-desc"><%=list.description%></div>','<div class="content-price"><span class="current-price">¥<%=list.current_price%></span><span class="old-price">¥<%=list.list_price%></span><span class="sale-num">已售:<%=list.purchase_count%></span></div>',"</div>","</li>","<% } %>","</ul>",'<div class="list-content-more hidden" <%if(item.deals.length>2){ %>style = "display:block;"<%}%> >更多团购项目</div>',"</li>","<% } %>","</ul>"].join(""),r=["<% if(is_show){  %>",'<li class="附近"><span>附近</span></li>',"<% } %>",'<li class="全部 selected"><span>全部商区</span></li>',"<% for(var i = 0; i < data.length; i++){ var item = data[i];%>",'<li class="<%=item.district_name%>"><span><%=item.district_name%></span></li>',"<% } %>"].join(""),n=["<% for(var i = 0; i < data.length; i++){ var item = data[i]; %>",'<li type="<%=item.type %>" value="<%=item.value%>"><span><%=item.area_second  %></span></li>',"<% } %>"].join(""),c=[{type:"fujin",area_second:"500米",value:500},{type:"fujin",area_second:"1000米",value:1e3},{type:"fujin",area_second:"2000米",value:2e3},{type:"fujin",area_second:"5000米",value:5e3},{type:"fujin",area_second:"不限距离",value:-1}],o=null,u=null,d=null,p=null,g=function(t){var e={};e.data=window.citys&&window.citys[t]?window.citys[t]:"北京",e.is_show=i.param.city==i.param.pos_city?!0:!1,$("#shangqu-second-scroll ul").html("");var s=Jumei.parseTpl(r,e);$("#shangqu-list-scroll ul").html(s),i.param.area&&($("#shangqu-list-scroll .selected").removeClass("selected"),$("."+i.param.area).addClass("selected"),h(i.param.area))},h=function(t){var e={};e.data=[];for(var i=window.citys[q.currentCity],s=0;s<i.length;s++)if(t==i[s].district_name)for(var a=i[s].neighborhoods,l=0;l<a.length;l++){var r={type:"area",value:a[l],area_second:a[l]};e.data.push(r)}var c=Jumei.parseTpl(n,e);$("#shangqu-second-scroll ul").html(c),C()},m=function(){if(q.category){$("#liren-list-scroll .selected").removeClass("selected"),$("."+q.category).addClass("selected");var t=$("."+q.category).attr("html");$(".category-liren span").html(t)}q.currentArea&&($("#shangqu-list-scroll .selected").removeClass("selected"),$("."+q.currentArea).addClass("selected"))},y=function(){$("#category_bg").on("touchmove",function(t){t.preventDefault()}),s=document.querySelector("#beauty-category-wrapper .pullUp"),$("#pullUpCategory").off("click"),$("#pullUpCategory").on("click",function(){s.querySelector(".pullUpLabel").innerHTML="加载中...",q.getList()})},v=function(){d||(d=new IScroll("#liren-list-scroll",{preventDefault:!1,scrollX:!1,scrollY:!0,momentum:!0,scrollbars:!0,fadeScrollbars:!0,shrinkScrollbars:"clip"}),$("#category-liren-list").on("touchmove",function(t){t.preventDefault()}))},f=function(){o||(o=new IScroll("#paixu-list-scroll",{preventDefault:!1,scrollX:!1,scrollY:!0,momentum:!0,scrollbars:!0,fadeScrollbars:!0,shrinkScrollbars:"clip"}),$("#category-paixu-list").on("touchmove",function(t){t.preventDefault()}))},b=function(){u=new IScroll("#shangqu-list-scroll",{preventDefault:!1,scrollX:!1,scrollY:!0,momentum:!0,scrollbars:!0,fadeScrollbars:!0,shrinkScrollbars:"clip"}),$("#category-shangqu-list").on("touchmove",function(t){t.preventDefault()})},_=function(){$("#shangqu-list-scroll ul li").length<=1?k():(b(),C())},C=function(){p?p.refresh():p=new IScroll("#shangqu-second-scroll",{preventDefault:!1,scrollX:!1,scrollY:!0,momentum:!0,scrollbars:!0,fadeScrollbars:!0,shrinkScrollbars:"clip"})},w={latitude:0,longitude:0},q={currentPage:0,currentCity:null,currentArea:null,totalPage:0,loadFlag:!0,category:"丽人",sort:1,radius:-1,getList:function(t){if(q.loadFlag){q.loadFlag=!1;var a={},r=this;null!=q.currentCity||0==w.latitude&&0==w.longitude?(a.city=q.currentCity||"北京",a.page=++r.currentPage,a.category=q.category,a.sort=q.sort,a.radius=q.radius,a.limit=15,null!=q.currentArea&&(a.region=q.currentArea),0!=w.latitude&&0!=w.longitude&&(a.longitude=w.longitude,a.latitude=w.latitude)):a={latitude:w.latitude,longitude:w.longitude,page:++r.currentPage,sort:q.sort,category:q.category,longitude:w.longitude,radius:q.radius,latitude:w.latitude,limit:15},$("#wrapper").loadding(),$.ajax({type:"get",dataType:"json",data:a,url:"/dp/getTopBusinessesByLocation",success:function(a){if($("#pullUpCategory").show(),$("#wrapper").loadding("close"),"OK"==a.status&&a.businesses.length>0){r.totalPage=a.total_count,a.param=i.param,a.param.distance=e,a.static=Jumei.static;var n=Jumei.parseTpl(l,a);1==t?$("#beauty_category .custom-container").html(n):$("#beauty_category .custom-container").append(n),$("#beauty_category .content-desc").subStr(46),$("#beauty_category .list-title .list-title-cut").subStr(35),$("#beauty-category-wrapper").height()>$("#category-scroll").height()?$("#pullUpCategory").hide():$("#pullUpCategory").show(),s&&(s.querySelector(".pullUpLabel").innerHTML="点击查看更多")}else 1==q.currentPage&&($("#beauty_category .custom-container").html('<div class="empty-tip"></div>'),x('<div class="dialog-alert">没有当前城市的团购信息！</div>')),$("#pullUpCategory").hide();q.loadFlag=!0},error:function(){q.loadFlag=!0,$("#wrapper").loadding("close")}})}}},k=function(){return window.citys?void g(i.param.city):void P()},j=function(t){window.citys={};for(var e in t)if(t.hasOwnProperty(e))for(var i=0;i<t[e].length;i++)window.citys[t[e][i].city_name]=t[e][i].districts},S=!0,P=function(t,e){S&&(S=!1,$.ajax({type:"get",dataType:"json",url:"/dp/getCities",success:function(s){S=!0,s&&(j(s),g(i.param.city),t&&t.call(i,e))},error:function(){S=!0}}))},x=function(t){i.hasCurrentView()&&$("#wrapper").dialog({width:260,height:200,content:t,title:"",type:1,init:function(){},ok:"我知道了",cancel:"取消",successCallback:function(){}})};return Jumei.create(t,{onCreate:function(){i=this,this.elem.html(a),q.currentPage=0,q.currentCity=this.param.city,q.sort=1,q.category=this.param.type,this.param.city==this.param.pos_city&&(w.latitude=this.param.latitude,w.longitude=this.param.longitude),i.param.area?(q.currentArea=i.param.area,$(".category-shangqu span").html(i.param.area)):q.currentArea=null,q.getList(!0),y(),k(),m()},onEvent:function(){var t=this;this.iscrollFlag=!1,this.events={"click .list-content li":function(){var e=$(this).parent().parent().find(".list-title").attr("business_id"),s=$(this).find("img").attr("src");Jumei.ja("dpevent","detail"+i.param.type),t.forward("#module=beauty&action=detail&deal_id="+$(this).attr("deal_id")+"&business_id="+e+"&latitude="+t.param.latitude+"&longitude="+t.param.longitude+"&image_url="+s)},"click .list-content-more":function(){$(this).hide(),$(this).parent().find(".list-content").height("auto"),t.refresh()},"click #category_bg":function(){$("#category-paixu-list").hide(),$("#category-shangqu-list").hide(),$("#category-liren-list").hide(),$(this).hide(),$("#category_bg").hide(),$(".category-select span").removeClass("hidden")},"touchmove #category_bg":function(t){t.preventDefault(),t.stopPropagation()},"click .category-select>span":function(){$(".category-common-type").hide();var t=$(this).attr("type");$(this).hasClass("hidden")?($(this).removeClass("hidden"),$("#category_bg").hide(),$("#"+t+"-list").hide()):($(this).addClass("hidden"),$("#category_bg").show(),$("#"+t+"-list").show(),"category-shangqu"==t?_():"category-liren"==t?v():"category-paixu"==t&&f()),$(this).siblings().removeClass("hidden")},"click #liren-list-scroll ul li":function(){$(this).hasClass("selected")||($(this).addClass("selected").siblings().removeClass("selected"),q.currentPage=0,q.category=$(this).attr("type"),q.getList(!0),$(".category-liren span").html($(this).html()),$(".category-liren").trigger("click"))},"click #shangqu-list-scroll ul li":function(){if(!$(this).hasClass("selected"))if($(this).addClass("selected").siblings().removeClass("selected"),$(this).hasClass("全部"))q.currentPage=0,q.currentArea=null,$("#shangqu-second-scroll ul").html(""),q.getList(!0),$(".category-shangqu span").html("全部商区"),$(".category-shangqu").trigger("click"),Jumei.ja("dpevent","sortall");else if($(this).hasClass("附近")){var t={};t.data=c;var e=Jumei.parseTpl(n,t);$("#shangqu-second-scroll ul").html(e),Jumei.ja("dpevent","sortfujin"),p.refresh()}else{var i=this,s=$(i).find("span").html().trim();window.citys?h(s):P(h,s)}},"click #shangqu-second-scroll ul li":function(){$(this).hasClass("selected")||("fujin"==$(this).attr("type")?(w.latitude=i.param.latitude,w.longitude=i.param.longitude,$(this).addClass("selected").siblings().removeClass("selected"),q.currentPage=0,$(".category-shangqu span").html("附近"),q.radius=$(this).attr("value"),q.getList(!0)):(w.latitude=0,w.longitude=0,$(this).addClass("selected").siblings().removeClass("selected"),q.currentPage=0,q.currentArea=$(this).find("span").html(),q.getList(!0),$(".category-shangqu span").html(q.currentArea)),$(".category-shangqu").trigger("click"))},"click #paixu-list-scroll ul li":function(){$(this).hasClass("selected")||($(this).addClass("selected").siblings().removeClass("selected"),q.currentPage=0,q.sort=$(this).attr("type"),0==w.latitude&&7==q.sort&&(q.sort=1),q.getList(!0),Jumei.ja("dpevent","sort"+$(this).html()),$(".category-paixu span").html($(this).html()),$(".category-paixu").trigger("click"))},"click .bottom":function(){$(".category-select span").removeClass("hidden"),$(".category-common-type").hide(),$("#category_bg").hide()}}},onClose:function(){},setTitle:function(){this.title("丽人生活团")},onRefresh:function(){this.setTitle()}})});