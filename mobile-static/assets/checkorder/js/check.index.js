$(function(){var e={init:function(){var e=this;e.canTapBtnFlag=!0,e.productArray=[],e.JMWebView=JMWebView;var a="http://mobile.jumei.com/msapi/order/order_wap.json?";e.orderId=Jumei.getQueryString(location.href,"order_id"),e.shippingNo=Jumei.getQueryString(location.href,"shipping_no"),$.ajax({url:a+"order_id="+e.orderId+"&shipping_no="+e.shippingNo,type:"get",dataType:"jsonp",success:function(a){if(!a)return!1;for(var t=a.item_details,s=0;s<t.length;s++){var i=t[s],r={product_id:i.product_id,sku:i.sku_no,order_id:e.orderId,shipping_no:e.shippingNo,hash_id:i.deal_hash_id,short_name:i.deal_short_name,type:i.type,shipping_system_id:a.shipping_system_id};e.productArray.push(r);var c='<div class="product-items"data-hashid="'+i.deal_hash_id+'"data-productid="'+i.product_id+'"data-sku="'+i.product_id+'"><div class="product-info-area clearfloat"><img class="product-img fl" src="'+i.image+'"><div class="product-des fl">'+e.subStr(i.deal_short_name,48)+'</div></div><div class="product-mark-stars-area"><div class="product-feel clearfloat" ><div class="feel-name fl">商品质量：</div><div class="stars-boxs fl"><span class="stars"><img class="star-img" src="http://images.jumei.com/mobile/act/activities/2014_12/1216_confirmOrder/star.png"></span><span class="stars"><img class="star-img" src="http://images.jumei.com/mobile/act/activities/2014_12/1216_confirmOrder/star.png"></span><span class="stars"><img class="star-img" src="http://images.jumei.com/mobile/act/activities/2014_12/1216_confirmOrder/star.png"></span><span class="stars"><img class="star-img" src="http://images.jumei.com/mobile/act/activities/2014_12/1216_confirmOrder/star.png"></span><span class="stars"><img class="star-img" src="http://images.jumei.com/mobile/act/activities/2014_12/1216_confirmOrder/star.png"></span></div></div><div class="product-feel-des clearfloat" ><div class="feel-name fl">填写短评：</div><textarea maxlength=120 class="des-input" type="text" placeholder="小美建议您多说说使用后的效果感受，可以使用之后再评论哦！建议不少于30字^^"></textarea></div></div></div>';$(".product-evaluate-items").append(c)}},error:function(){alert("网络错误!")}}),e.getModuleFunc(),e.addEventListener()},addEventListener:function(){var e=this;$(window).on("tap",".stars-boxs",function(e){var a=e.target;if("star-img"==e.target.className.toLowerCase()){var t=$(a).parent("span").index(),s=$(this).find("span");$(this).find(".active").removeClass("active");for(var i=0;t>=i;i++)$(s[i]).addClass("active")}}),$(".draw-cancel").on("click",function(){e.dialogObj.hide(),e.JMWebView.close()}),$(".chose-boxs span").on("click",function(){$(".chose-boxs .selected").removeClass("selected"),$(this).addClass("selected")}),$(".confirm-receipt").on("click",function(){Jumei.ja("querenshouhuo","click","btn_fabupingjia");var a=$(".chose-boxs .selected").attr("data-numb"),t=$(".logistic .active").length,s=$(".service .active").length;if(!a||0==t||0==s)return alert("请完成所有评分项再提交哦"),!1;for(var i=$(".product-items"),r=0;r<i.length;r++){var c=$(i[r]).find(".product-feel .active").length,o=$(i[r]).find(".product-feel-des textarea")[0].value;if(0==c)return alert("请完成所有评分项再提交哦"),!1;e.productArray[r].productQualityScore=c,e.productArray[r].comments=o,e.productArray[r].sellerAttitudeScore=s,e.productArray[r].deliverySpeedScore=t,e.productArray[r].recommendScore=a}e.canTapBtnFlag&&(e.length=e.productArray.length-1,e.ajaxFunc(e.length))})},ajaxFunc:function(e){var a=this,t=e;if(-1==e&&a.endSuccessCallback(),e>=0){var s=a.productArray,i="http://mobile.jumei.com/msapi/order/comment_order_wap.json?product_id="+s[e].product_id+"&sku="+s[e].sku+"&order_id="+s[e].order_id+"&shipping_no="+s[e].shipping_no+"&hash_id="+s[e].hash_id+"&shipping_system_id="+s[e].shipping_system_id+"&short_name="+s[e].short_name+"&type="+s[e].type+"&productQualityScore="+s[e].productQualityScore+"&comments="+s[e].comments+"&sellerAttitudeScore="+s[e].sellerAttitudeScore+"&deliverySpeedScore="+s[e].deliverySpeedScore+"&recommendScore="+s[e].recommendScore;$.ajax({url:i,type:"GET",dataType:"jsonp",success:function(e){return a.status=e.status,"success"!=e.status?(alert(e.msg),"已评论"==e.msg.toLowerCase()&&a.JMWebView.close(),Jumei.ja("querenshouhuo","click","fabupingjiashibai"),a.canTapBtnFlag=!0,!1):(a.canTapBtnFlag=!1,void a.ajaxFunc(t-1))},error:function(){alert("网络错误！"),a.canTapBtnFlag=!0}})}},endSuccessCallback:function(){var e=this,a="http://mobile.jumei.com/msapi/order/lottery_times.json?order_id="+e.orderId+"&callback=comment_order";Jumei.ja("querenshouhuo","click","fabupingjiachenggong"),e.toastObj.show("确认收货并评价成功!"),$.ajax({url:a,type:"GET",dataType:"jsonp",success:function(a){return e.canTapBtnFlag=!0,a.status?void("success"==a.status?(e.drawTimes=a.times,e.drawTimes>0?(e.dialogObj.show(),Jumei.ja("querenshouhuo","click","choujiantanchuang")):($(".confirm-receipt").off("click"),e.JMWebView.close())):(alert(a.msg),e.JMWebView.close())):!1},error:function(){e.canTapBtnFlag=!0,alert("网络错误！")}})},getModuleFunc:function(){var e=this,a=Jumei.getModule("ui.dialog");e.dialogObj=new a({title:"消息",btn:0,content:'<div class="draw-tips-area clearfloat"><div class="draw-tips-text">评价成功啦，点击“参加抽奖”有惊喜哦!</div><div class="text-small">您也可以在「我的聚美」中再次进入抽奖</div><div class="draw-btn-boxs clearfloat"><span class="draw-cancel fl">下次再说</span><a class="draw-sure fl" href="http://s.h5.jumei.com/pages/1491">参加抽奖</a></div></div>'});var t=Jumei.getModule("ui.toast");e.toastObj=new t({animateTime:.8,animateCurves:"ease",stopTime:.8,animateEndCallback:function(){}})},subStr:function(e,a){var t,s,i=e.replace(/[^\x00-\xff]/g,"**").length,r=2,c=a;if(i>c){for(t=0;t<e.length;){var o=e.charAt(t),n=o.replace(/[^\x00-\xff]/g,"**").length;if(r+=n,!(c>=r)){s=e.slice(0,t),s+="...";break}t++}return s}return e}};e.init()});