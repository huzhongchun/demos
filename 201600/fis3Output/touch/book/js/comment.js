require(["book/js/public"],function(t){function e(t){$.ajax({url:"/book/comment/get_comment_poster_img",type:"get",data:{comment_id:t},dataType:"json",success:function(t){0==t.code?window.location.href="/book/comment/comment_poster?poster="+encodeURIComponent(t.result.url):alert(t.message.text),i.hide()},error:function(t){var e=JSON.parse(t.responseText);alert(e.message.text),i.hide()}})}var o=t,n=$(".hidden-bookId-value").val(),r=$(".hidden-productId-value").val(),a=$(".hidden-orderId-value").val();o.setWxShareContent(),o.initCommentStars();var i=o.loading;i.init();var s=$.getQueryString(location.href,"refer"),l=function(t,e,o){e=e||0;var n=!!document.getBoxObjectFor||"mozInnerScreenX"in window,r=!!window.opera&&!!window.opera.toString().indexOf("Opera"),a=function(e,o){t.addEventListener?t.addEventListener(e,o,!1):t.attachEvent("on"+e,o)},i=t.currentStyle?function(e){var o=t.currentStyle[e];if("height"===e&&1!==o.search(/px/i)){var n=t.getBoundingClientRect();return n.bottom-n.top-parseFloat(i("paddingTop"))-parseFloat(i("paddingBottom"))+"px"}return o}:function(e){return getComputedStyle(t,null)[e]},s=parseFloat(i("height"));t.style.resize="none";var l=function(){var a,l,c=0,d=t.style;t._length!==t.value.length&&(t._length=t.value.length,n||r||(c=parseInt(i("paddingTop"))+parseInt(i("paddingBottom"))),a=document.body.scrollTop||document.documentElement.scrollTop,t.style.height=s+"px",t.scrollHeight>s&&(o&&t.scrollHeight>o?(l=o-c,d.overflowY="auto"):(l=t.scrollHeight-c,d.overflowY="hidden"),d.height=l+e+"px",a+=parseInt(d.height)-t.currHeight,t.currHeight=parseInt(d.height)))};a("propertychange",l),a("input",l),a("focus",l),l()};l($(".input-comment")[0]),$(".star-list .star-icon").on("click",function(){var t=$(this).index();$(".star-list .active").removeClass("active");for(var e=$(".star-list .star-icon"),o=0;t>=o;o++)$(e[o]).addClass("active");4==t?$(".star-text").html("力荐"):3==t?$(".star-text").html("推荐"):2==t?$(".star-text").html("还行"):1==t?$(".star-text").html("较差"):0==t&&$(".star-text").html("很差")}),$(".submit-btn").on("click",function(){var t=this,o=$(".star-list .active").length,l=$(".input-comment").val().trim();return $(t).hasClass("active")?!1:0==o?(alert("请给这本书打分"),!1):l?($(t).addClass("active"),i.show(),void $.ajax({url:"/book/comment/add_comment",type:"post",data:{grade:o,content:encodeURIComponent(l),book_id:n,product_id:r,order_id:a},success:function(o){if(0==o.code)try{o.result.data.comment_id?e(o.result.data.comment_id):window.location.href=s?s:"/book/user/book_list"}catch(n){window.location.href=s?s:"/book/user/book_list"}else alert(o.message.text);$(t).removeClass("active")},error:function(e){var o=JSON.parse(e.responseText);alert(o.message.text),$(t).removeClass("active")}})):(alert("请输入书评内容"),!1)})});