var Controller=Jumei.create({init:function(t){this._direction="left",this._emptyElement=null,this._module=null,this._action=null,this._baseUrl=location.protocol+"//"+location.host,this._hasPushState=!(!window.history||!window.history.pushState),this._url="",this._hash="",this._param=null,this._hashStack=[],this._uuid=this.getStoryItem("mvc_uuid")?this.getStoryItem("mvc_uuid"):0,this.view={},this.name="",Jumei.mix(this,t,!0),this._supportLocalStorage=!!window.localStorage,this.buildEvent(),this.defaultAction(),this.lookNum=0,this.viewObj={}},getUuid:function(){var t=++this._uuid;return this.setStoryItem("mvc_uuid",t),t},pushStack:function(t){this._hashStack.push(t)},popStack:function(){return this._hashStack.pop()},unshiftStack:function(t){return this._hashStack.unshift(t)},getLastStack:function(){var t=this._hashStack.length;return this._hashStack[t-2]},getLocalStory:function(t){return this._supportLocalStorage?window.localStorage.getItem(t):void 0},setLocalStroy:function(t,i){if(this._supportLocalStorage)try{window.localStorage.setItem(t,i)}catch(e){var a=function(){};window.localStorage.__proto__={setItem:a,getItem:a,removeItem:a,clear:a}}},getStoryItem:function(t){return Jumei.getCookie(t)},setStoryItem:function(t,i){Jumei.setCookie(t,i,365,"/")},defaultAction:function(){this.pushStack(location.href),""!=location.hash&&this.showView(),this.heightHeader(),this.headShow(),this.bindHeader()},heightHeader:function(){var t=$("#header");if($.os.iphone){var i=navigator.userAgent,e=i.match(/.*OS\s*(\d)/);e[1]&&e[1]>6?(t.css("padding-top","0px"),$("#container").css("padding-top","40px")):(t.css("padding-top","0px"),$("#container").css("padding-top","40px"))}else t.css("padding-top","0px"),$("#container").css("padding-top","40px");t.height(40)},bindHeader:function(){var t=this;$("#home").on("tap",function(){t.forward("#module="+t._module+"&action=index")}),$("#back").on("tap",function(){return t._action&&"index"==t._action?!1:void history.go(-1)})},buildEvent:function(){var t=this;this._hasPushState?$(window).bind("popstate",function(){$("#container-dialog").remove(),t.historyShowView(t.getLastStack()==location.href?"right":"left"),t.headShow()}):$(window).bind("hashchange",function(){1==t._flag?(t._direction="left",t._flag=!1,t.showView()):($("#container-dialog").remove(),t.historyShowView(t.getLastStack()==location.href?"right":"left")),t.headShow()})},pushHistory:function(){this.ja()},parseHashUrl:function(){var t=null,i=null,e=null,a=null,n={};if(this.hash=decodeURIComponent(location.hash).replace(/\?.*/,""),null!=this.hash){t=this.hash.substr(1),i=t.split("&");for(var o=0;o<i.length;o++)a=i[o],e=a.split("="),e.length>1&&(n[e[0]]=decodeURIComponent(e[1]))}this._action=n.action||"index",this._module=n.module,delete n.action,delete n.module,this._param=n},getHashUrl:function(t){var i="",e=0;for(var a in t)i+=0==e?a+"="+t[a]:"&"+a+"="+t[a],++e;return i},getUrl:function(){var t="";return t+=this._baseUrl?this._baseUrl:"",t+=this._module&&void 0!=this._module?"/"+this._module:"",t+=this._action&&void 0!=this._action?"/"+this._action:"",t+=this._param&&""!=this._param?"?"+this.getHashUrl(this._param):""},historyShowView:function(t){if(location.hash){this.parseHashUrl();var i=this._module+"_"+this._action,e=this.view[i],a=this;if(e){var n=$(".current"),o=n[0];if(n.removeClass("current"),$(e).addClass("current"),o==e)return;"left"==t?(a.pushStack(location.href),a._direction="left"):(a.popStack(),a._direction="right"),this.switchView(o,e),a.viewObj[i].onRefresh()}else{a.popStack(),a.unshiftStack(location.href);var o=$(".current")[0];$(o).removeClass("current"),$("#wrapper").loadding(),this.view[i]=$('<div class="current page" id="'+i+'"><div class="main"></div></div>')[0],$("#container").append(a.view[i]),this.loadView(function(){a._direction="right",a.switchView(o,this.view[i])})}this.ja()}},headShow:function(){"index"==this._action?$("#home").hide():$("#home").show()},showView:function(){this._direction="left",this.parseHashUrl(),this.headShow();var t=this._module+"_"+this._action,i=this.view[t],e=this;if(i){var a=$(".current"),n=a[0];if(a.removeClass("current"),$(i).addClass("current"),n==i)return;$(i).html(""),$("#wrapper").loadding(),this.loadView(function(){e.switchView(n,i)})}else if($("#container").children().length<=0)this.view[t]=$('<div class="current page" id="'+t+'"><div class="main"></div></div>')[0],$("#container").append(e.view[t]),$("#wrapper").loadding(),this.loadView(function(){});else{var n=$(".current")[0];$(n).removeClass("current"),$("#wrapper").loadding(),this.view[t]=$('<div class="current page" id="'+t+'"><div class="main"></div></div>')[0],$("#container").append(e.view[t]),this.loadView(function(){e.switchView(n,this.view[t])})}},loadView:function(t){var i="",e=this;i=this._module+"_"+this._action,$("#wrapper").loadding(),requirejs([this._module+"/"+this._action],function(a){$("#wrapper").loadding("close"),e.viewObj[i]=new a,e.viewObj[i]&&e.viewObj[i].initialize(e),e._direction="left",t.call(e)})},getUniqueHash:function(t){return t+"?"+this.getUuid()},back:function(){var t=this;t._direction="right",t._flag=!1,t.historyShowView()},forward:function(t){var i="",e=this,a=location.href;a=a.replace(/\#.*|\?.*/,""),i=this.getUniqueHash(t),this._hasPushState?(history.pushState("",{},a+i),e.pushStack(location.href),e.showView()):(location.hash=i,e.pushStack(location.href),e._flag=!0),this.headShow(),this.ja()},ja:function(){this.parseHashUrl(),Jumei.ja(this.name+"page",this._module+"/"+this._action)},loadJs:function(t,i){var e=this,a=document.createElement("script"),n=a.onreadystatechange?"onreadystatechange":"onload";a.async="async",a[n]=function(){(!a.onreadystatechange||/loaded|complete/i.test(a.readyState))&&i.call(e)},a.onerror=function(){a.onload=a.onreadystatechange=a.onerror=null,head.removeChild(a)},a.src=t,head.insertBefore(a,head.firstChild)},createElement:function(){return null==this._emptyElement&&(this._emptyElement=document.createElement("div"),$(this._emptyElement).addClass("page")),this._emptyElement.cloneNode(!0)},switchView:function(t,i){var e=function(){$(this).attr("style",""),this.removeEventListener("webkitAnimationEnd",e,!1),"old-container"==$(this).attr("page-id")&&$(this).hide(),$(this).removeClass("slide"),$(this).removeClass("reverse")},a=$(t),n=(t.parentNode,$(i));a.show(),t.addEventListener("webkitAnimationEnd",e,!1),a.attr("page-id","old-container"),n.attr({"page-id":"container"}),i.addEventListener("webkitAnimationEnd",e,!1),"left"==this._direction?(n.removeClass("out").addClass("slide").addClass("in"),a.removeClass("in").addClass("slide").addClass("out")):(n.removeClass("out").addClass("reverse").addClass("in"),a.removeClass("in").addClass("reverse").addClass("out"))},getContentContainer:function(){var t=$("#container")[0];if(!t){t=this.createElement(),$(t).attr(t,"id","container"),$(t).attr(t,"class","container");var i=$("#wrapper");i.appendChild(t)}return t}});