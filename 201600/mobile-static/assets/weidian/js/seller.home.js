$(function(){var i=Jumei.addModule("weidian",{init:function(){$(".des").subStr(80),$(".goods-row-two-des").subStr(40);var i=null,e=1;$(document).on("touchstart",function(){i=$(window).scrollTop()}),$(window).scroll(function(){var t=$(window).scrollTop();t>i?1==e&&setTimeout(function(){$("#bottom-nav").addClass("fixedhide"),e=0},100):0==e&&setTimeout(function(){$("#bottom-nav").removeClass("fixedhide"),e=1},100)});for(var t=$(".module-boxs"),a=0;a<t.length;a++)$(t[a]).find(".goods-row-two-area").children().length<22&&$(t[a]).find(".get-more").hide();$(".imglazy").imglazyload({classSelector:".imglazy"}),this.initEventListener(),this.getNeedModule(),this.isFirstVisit(),this.refreshFuc()},getNeedModule:function(){var i=this,e=Jumei.getModule("ui.share");i.shareObj=new e({});var t=Jumei.getModule("ui.toast");i.toastObj=new t({animateTime:.5,animateCurves:"ease",stopTime:.8});var a=Jumei.getModule("ui.dialog");i.dialogObj=new a({title:"分享到",btn:0,content:'<div class="share-btns-area clearfloat"><span class="share-btn-icon fl friend-chart" type="wechat"></span><span class="share-btn-icon fl friend-circle" type="weixin-friend"></span><a class="fl copy-link" type="copy-link"></a></div>'})},initEventListener:function(){var i=this;i.n=1,$(".select-goods-area").on("click",function(e){$(this).parent().find(".selected-recomend-goods-area").children().length>=6&&(e.preventDefault(),i.toastObj.show("别贪心，只能推荐6个商品哟！"))}),$(".edit-nikename-boxs input").on("keydown",function(i){"13"==i.keyCode&&i.preventDefault()}),$(".check-btn").on("click",function(){$(".tips-full-bg").remove()}),$(".full-bg").on("touchmove",function(i){i.preventDefault()}),$(".edit-icon").on("click",function(){i.showEditBoxs()}),$(".btn-cancel").on("click",function(){i.hideEditBoxs()}),$(".btn-sure").on("click",function(){i.changeNikeName()}),$(".goods-row-two-items").click(function(){Jumei.ja("weidianAPP","click","dianjishangpinxiangqing")}),$(".selected-recomend-goods-area").click(function(){Jumei.ja("weidianAPP","click","dianjishangpinxiangqing")});var e=function(e){this.className.indexOf("store-share")>-1?Jumei.ja("weidianAPP","click","dianpufenxiang"):Jumei.ja("weidianAPP","click","shangpinfenxiang"),e.stopPropagation(),e.preventDefault();var t=$(this).attr("data-img"),a=$(this).attr("data-link"),o=$(this).attr("data-title"),n=$(this).attr("data-content");$(".copy-link").attr("href","/microshop/overview/copyUrl?"+a),i.dialogObj.show(),$(".share-btn-icon").off("click"),$(".share-btn-icon").on("click",function(){var e=$(this).attr("type");i.shareObj.openUrl(e,{weiXinChatLinkUrl:a,weixinChatTitle:o,weiXinChatPic:t,weiXinChatContent:n,weiXinFriendLinkUrl:a,weiXinFriendTitle:n,weiXinFriendPic:t,weiXinFriendContent:n}),i.dialogObj.hide(),i.toastObj.show("分享进行中...")})};$(".store-share").click(e),$(window).on("click",".share-btn",e),$(window).on("click",".goods-row-two-share-btn",e);var t=$(".shelf-btn");t.click(function(e){e.stopPropagation(),e.preventDefault(),Jumei.ja("weidianAPP","click","shangpinxiajia");var t=this,a=$(this).attr("data-hashid");confirm("商品将从店长推荐中移除?")&&$.ajax({url:"/microshop/manage/ajaxCancelRecommendation",type:"POST",data:{item_id:a},success:function(e){"ok"==e?($(t).parents(".selected-recomend-goods-items").remove(),i.toastObj.show("商品已移出我的推荐"),window.location.reload()):i.toastObj.show("移出商品失败")},error:function(){alert("网络错误！")}})}),$(".get-more").click(function(){var e=this;i.shopName=$(".name-text").html(),i.category=$(this).attr("data-type");var t=$(this).parent().children()[1];$.ajax({url:"/microshop/manage/ajaxGetPageByCategory?category="+i.category+"&page="+ ++i.n,type:"GET",dataType:"json",success:function(a){if(a.length<22&&$(e).hide(),0==a.length)return alert("对不起，没有更多的商品了~！"),!1;for(var o=0;o<a.length;o++){var n="",s=a[o],r=s.image[0]?s.image[0]:s.original_image,c="undefined"==typeof s.dx_image?r:s.dx_image;if("本季热卖"==i.category){var d=s.description?s.description:s.medium_name;n='<a class="selected-recomend-goods-items" href="/microshop/buy/detail?shop_id=1___item_id='+s.jumei_item_id+"___item_type="+s.jumei_item_type+'___can_buy=false"><div class="goods-pic"><img class="imglazy" src="'+c+'"><div class="commission_icon">佣金￥'+s.commission+'</div></div><div class="goods-des"><span class="recommend-txt">推荐</span><span class="des">'+d+'</span></div><div class="goods-price clearfloat"><div class="price-area fl"><span class="price-now">￥'+s.discounted_price+'</span><span class="price-old">￥'+s.original_price+'</span></div><div class="shelf-btn fr" data-hashid="'+s.id+'"></div><div class="share-btn fr" data-img="'+s.original_image+'" data-link="'+s.share_url+'" data-content="'+s.share_txt+'" data-title="'+i.shopName+'"></div></div></a>'}else n='<a class="goods-row-two-items fl" href="/microshop/buy/detail?shop_id=1___item_id='+s.jumei_item_id+"___item_type="+s.jumei_item_type+'___can_buy=false"><div class="goods-row-two-pic"><img class="imglazy" src="'+s.original_image+'"><div class="goods-row-two-commission-icon">佣金￥'+s.commission+'</div></div><div class="goods-row-two-des">'+s.medium_name+'</div><div class="goods-row-two-price clearfloat"><div class="goods-row-two-price-boxs fl"><span class="goods-row-two-price-now">￥'+s.discounted_price+'</span><span class="goods-row-two-price-old">￥'+s.original_price+'</span></div><div class="goods-row-two-share-btn fr" data-img="'+s.original_image+'" data-link="'+s.share_url+'" data-content="'+s.share_txt+'" data-title="'+i.shopName+'" >分享</div></div></a>';$(t).append(n)}},error:function(){alert("网络错误！")}})})},showEditBoxs:function(){var i=$(window).height(),e=$(window).width(),t=parseInt((i-151)/2),a=parseInt((e-243)/2);$(".edit-nikename-boxs").css({top:t+"px",left:a+"px"}),$(".full-bg").show()},hideEditBoxs:function(){$(".full-bg").hide()},isFirstVisit:function(){var i=window.localStorage&&1==window.localStorage.getItem("weidian_first_visit")?!1:!0;i&&($(".tips-full-bg").show(),window.localStorage&&window.localStorage.setItem("weidian_first_visit",1))},changeNikeName:function(){var i=this,e=$(".edit-nikename-boxs input")[0].value;if(""==e)alert("请输入昵称！");else{if(""==e.trim()||e.trim().indexOf(" ")>-1)return alert("昵称不能包含空格哦！请重新输入"),$(".edit-nikename-boxs input")[0].value="",!1;$(".name-boxs .name-text").html(e.trim()+"的微店"),i.hideEditBoxs(),$(".edit-nikename-boxs input")[0].value="",$.ajax({url:"/microshop/manage/ajaxUpdateShopName",type:"POST",data:{name:e},success:function(e){i.toastObj.show("ok"==e?"修改成功":"修改失败!")},error:function(){alert("网络错误！")}})}},refreshFuc:function(){var i=$("#content").attr("data-time");Jumei.getCookie("timestamp")&&i==Jumei.getCookie("timestamp")?location.reload():Jumei.setCookie("timestamp",i)}});i.init()});